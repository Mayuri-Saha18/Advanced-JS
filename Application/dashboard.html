<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
    nav ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
        background-color: #333;
        overflow: hidden;
    }

    nav li {
        float: left;
    }

    nav li a {
        display: block;
        color: white;
        text-align: center;
        padding: 10px;
        text-decoration: none;
    }

    nav li a:hover {
        background-color: #111;
    }

    h1 {
        text-align: center;
    }

    form {
        width: 40%;
        margin:auto;
        border: 1px solid gray;
        padding: 10px;
        background-color: aquamarine;
    }

    label {
        display: block;
        color: blue;
    }

    input[type=text], select, textarea {
        width: 100%;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        
    }

    input[type=radio] {
        margin-right: 10px;
    }

    button[type=submit] {
        background-color: #1e5920;
        color: white;
        padding: 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: auto;
        display: block;
    }

    button[type=submit]:hover {
        background-color: #459ba0;
    }

    .success {
        color: green;
        text-align: center;
    }
</style>
</head>
<body>
      <!-- Navbar -->
      <nav>
        <ul>
            <li><a href="index.html">Leave Request Page</a></li>
            <li><a href="dashboard.html">Dashboard Page</a></li>
            <li><a href="status.html">Status Page</a></li>
        </ul>
    </nav>
    <h1>Dashboard</h1>
	<label for="designation-filter">Filter by Designation:</label>
	<select id="designation-filter">
		<option value="">All</option>
		<option value="Employee">Employee</option>
		<option value="Student">Student</option>
	</select>
	<br>
	<label for="name-search">Search by Name:</label>
	<input type="text" id="name-search">
	<br><br>
	<table id="leave-table">
		<thead>
			<tr>
				<th>Unique ID</th>
				<th>Name</th>
				<th>Reason for Leave</th>
				<th>Designation</th>
				<th>Start Date</th>
				<th>End Date</th>
				<th>Days</th>
				<th>Overseer</th>
				<th>OTP</th>
				<th>Actions</th>
			</tr>
		</thead>
		<tbody>
			<!-- Leave requests will be inserted here -->
		</tbody>
	</table>

	<!-- Modal for OTP verification -->
	<div id="otp-modal" style="display: none">
		<h2>Grant Leave</h2>
		<p>Please enter the OTP sent to the user's email or phone number:</p>
		<input type="text" id="otp-input" placeholder="Enter OTP">
		<button id="otp-submit">Submit</button>
		<button id="otp-cancel">Cancel</button>
	</div>

	<script>
		const leaveTable = document.querySelector('#leave-table');
		const designationFilter = document.querySelector('#designation-filter');
		const nameSearch = document.querySelector('#name-search');
		const otpModal = document.querySelector('#otp-modal');
		const otpInput = document.querySelector('#otp-input');
		const otpSubmit = document.querySelector('#otp-submit');
		const otpCancel = document.querySelector('#otp-cancel');

		// Populate leave table from LocalStorage
		const leaveData = JSON.parse(localStorage.getItem('leaveData')) || [];
		populateTable(leaveData);

		// Handle filter, search, sort, and actions
		designationFilter.addEventListener('change', filterTable);
		nameSearch.addEventListener('input', searchTable);
		leaveTable.addEventListener('click', handleActions);
		window.addEventListener('load', sortTable);

		function populateTable(data) {
			const tbody = leaveTable.querySelector('tbody');
			tbody.innerHTML = '';
			data.forEach((leave) => {
				const row = document.createElement('tr');
				row.dataset.id = leave.uniqueId;
				row.innerHTML = `
					<td>${leave.uniqueId}</td>
					<td>${leave.name}</td>
					<td>${leave.reason}</td>
					<td>${leave.designation}</td>
					<td>${leave.startDate}</td>
					<td>${leave.endDate}</td>
					<td>${calculateDays(leave.startDate, leave.endDate)}</td>
					<td>${leave.overseer}</td>
					<td>${generateOTP()}</td>
					<td>
						<button class="reject">Reject Leave</button>
						<button class="grant">
                        </button>
					</td>
				`;
				tbody.appendChild(row);
			});
		}

	function generateOTP() {
		const otp = Math.floor(1000 + Math.random() * 9000);
		return otp;
	}

	function filterTable() {
		const designation = designationFilter.value;
		const filteredData = leaveData.filter((leave) => leave.designation === designation);
		populateTable(filteredData);
		sortTable();
	}

	function searchTable() {
		const searchTerm = nameSearch.value.toLowerCase();
		const filteredData = leaveData.filter((leave) => leave.name.toLowerCase().includes(searchTerm));
		populateTable(filteredData);
		sortTable();
	}

	function handleActions(e) {
		if (e.target.classList.contains('reject')) {
			if (confirm('Are you sure you want to reject this leave application?')) {
				const row = e.target.closest('tr');
				const id = row.dataset.id;
				removeRow(id);
			}
		}
		if (e.target.classList.contains('grant')) {
			const row = e.target.closest('tr');
			const id = row.dataset.id;
			const leave = leaveData.find((leave) => leave.uniqueId === id);
			otpModal.querySelector('#modal-name').textContent = leave.name;
			otpModal.querySelector('#modal-designation').textContent = leave.designation;
			otpModal.querySelector('#modal-start-date').textContent = leave.startDate;
			otpModal.querySelector('#modal-end-date').textContent = leave.endDate;
			otpModal.style.display = 'block';
			otpSubmit.addEventListener('click', handleOTP);
			otpCancel.addEventListener('click', handleModalClose);
		}
	}

	function handleOTP(e) {
		e.preventDefault();
		const row = otpModal.querySelector(`tr[data-id="${id}"]`);
		const otp = parseInt(otpInput.value);
		const leave = leaveData.find((leave) => leave.uniqueId === id);
		if (otp === leave.otp) {
			removeRow(id);
			handleModalClose();
		} else {
			alert('Incorrect OTP entered. Please try again.');
		}
	}

	function removeRow(id) {
		const index = leaveData.findIndex((leave) => leave.uniqueId === id);
		leaveData.splice(index, 1);
		localStorage.setItem('leaveData', JSON.stringify(leaveData));
		const row = leaveTable.querySelector(`tr[data-id="${id}"]`);
		row.remove();
	}

	function handleModalClose() {
		otpModal.style.display = 'none';
		otpInput.value = '';
		otpSubmit.removeEventListener('click', handleOTP);
		otpCancel.removeEventListener('click', handleModalClose);
	}

	function calculateDays(startDate, endDate) {
		const start = new Date(startDate);
		const end = new Date(endDate);
		const diff = Math.abs(end - start);
		const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
		return days;
	}

	function sortTable() {
		const rows = leaveTable.querySelectorAll('tbody tr');
		const sortedRows = Array.from(rows).sort((a, b) => {
			const aDays = parseInt(a.children[6].textContent);
			const bDays = parseInt(b.children[6].textContent);
			return bDays - aDays;
		});
		leaveTable.querySelector('tbody').innerHTML = '';
		sortedRows.forEach((row) => leaveTable.querySelector('tbody').appendChild(row));
	}
</script>
</body>
</html>